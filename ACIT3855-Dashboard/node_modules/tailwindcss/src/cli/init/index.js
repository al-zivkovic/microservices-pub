// @ts-check

import fs from 'fs'
import path from 'path'

<<<<<<< HEAD
function isESM() {
  const pkgPath = path.resolve('./package.json')

  try {
    let pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'))
    return pkg.type && pkg.type === 'module'
  } catch (err) {
    return false
  }
}

export function init(args) {
  let messages = []

  let isProjectESM = args['--ts'] || args['--esm'] || isESM()
  let syntax = args['--ts'] ? 'ts' : isProjectESM ? 'js' : 'cjs'
  let extension = args['--ts'] ? 'ts' : 'js'

  let tailwindConfigLocation = path.resolve(args['_'][1] ?? `./tailwind.config.${extension}`)

  if (fs.existsSync(tailwindConfigLocation)) {
    messages.push(`${path.basename(tailwindConfigLocation)} already exists.`)
  } else {
    let stubContentsFile = fs.readFileSync(
      args['--full']
        ? path.resolve(__dirname, '../../../stubs/config.full.js')
        : path.resolve(__dirname, '../../../stubs/config.simple.js'),
      'utf8'
    )

    let stubFile = fs.readFileSync(
      path.resolve(__dirname, `../../../stubs/tailwind.config.${syntax}`),
=======
export function init(args, configs) {
  let messages = []

  let tailwindConfigLocation = path.resolve(args['_'][1] ?? `./${configs.tailwind}`)
  if (fs.existsSync(tailwindConfigLocation)) {
    messages.push(`${path.basename(tailwindConfigLocation)} already exists.`)
  } else {
    let stubFile = fs.readFileSync(
      args['--full']
        ? path.resolve(__dirname, '../../../stubs/defaultConfig.stub.js')
        : path.resolve(__dirname, '../../../stubs/simpleConfig.stub.js'),
>>>>>>> 673f6c3a713c3c5a521125c5e4ea6135afefe034
      'utf8'
    )

    // Change colors import
<<<<<<< HEAD
    stubContentsFile = stubContentsFile.replace('../colors', 'tailwindcss/colors')

    // Replace contents of {ts,js,cjs} file with the stub {simple,full}.
    stubFile =
      stubFile
        .replace('__CONFIG__', stubContentsFile.replace('module.exports =', '').trim())
        .trim() + '\n\n'
=======
    stubFile = stubFile.replace('../colors', 'tailwindcss/colors')
>>>>>>> 673f6c3a713c3c5a521125c5e4ea6135afefe034

    fs.writeFileSync(tailwindConfigLocation, stubFile, 'utf8')

    messages.push(`Created Tailwind CSS config file: ${path.basename(tailwindConfigLocation)}`)
  }

  if (args['--postcss']) {
<<<<<<< HEAD
    let postcssConfigLocation = path.resolve('./postcss.config.js')
=======
    let postcssConfigLocation = path.resolve(`./${configs.postcss}`)
>>>>>>> 673f6c3a713c3c5a521125c5e4ea6135afefe034
    if (fs.existsSync(postcssConfigLocation)) {
      messages.push(`${path.basename(postcssConfigLocation)} already exists.`)
    } else {
      let stubFile = fs.readFileSync(
<<<<<<< HEAD
        isProjectESM
          ? path.resolve(__dirname, '../../../stubs/postcss.config.js')
          : path.resolve(__dirname, '../../../stubs/postcss.config.cjs'),
=======
        path.resolve(__dirname, '../../../stubs/defaultPostCssConfig.stub.js'),
>>>>>>> 673f6c3a713c3c5a521125c5e4ea6135afefe034
        'utf8'
      )

      fs.writeFileSync(postcssConfigLocation, stubFile, 'utf8')

      messages.push(`Created PostCSS config file: ${path.basename(postcssConfigLocation)}`)
    }
  }

  if (messages.length > 0) {
    console.log()
    for (let message of messages) {
      console.log(message)
    }
  }
}
