/* global __webpack_dev_server_client__ */
<<<<<<< HEAD

import WebSocketClient from "./clients/WebSocketClient.js";
import { log } from "./utils/log.js";

// this WebsocketClient is here as a default fallback, in case the client is not injected
/* eslint-disable camelcase */
var Client =
// eslint-disable-next-line no-nested-ternary
=======
import WebSocketClient from "./clients/WebSocketClient.js";
import { log } from "./utils/log.js"; // this WebsocketClient is here as a default fallback, in case the client is not injected

/* eslint-disable camelcase */

var Client = // eslint-disable-next-line no-nested-ternary
>>>>>>> 673f6c3a713c3c5a521125c5e4ea6135afefe034
typeof __webpack_dev_server_client__ !== "undefined" ? typeof __webpack_dev_server_client__.default !== "undefined" ? __webpack_dev_server_client__.default : __webpack_dev_server_client__ : WebSocketClient;
/* eslint-enable camelcase */

var retries = 0;
<<<<<<< HEAD
var maxRetries = 10;

// Initialized client is exported so external consumers can utilize the same instance
// It is mutable to enforce singleton
// eslint-disable-next-line import/no-mutable-exports
export var client = null;

=======
var maxRetries = 10; // Initialized client is exported so external consumers can utilize the same instance
// It is mutable to enforce singleton
// eslint-disable-next-line import/no-mutable-exports

export var client = null;
>>>>>>> 673f6c3a713c3c5a521125c5e4ea6135afefe034
/**
 * @param {string} url
 * @param {{ [handler: string]: (data?: any, params?: any) => any }} handlers
 * @param {number} [reconnect]
 */
<<<<<<< HEAD
=======

>>>>>>> 673f6c3a713c3c5a521125c5e4ea6135afefe034
var socket = function initSocket(url, handlers, reconnect) {
  client = new Client(url);
  client.onOpen(function () {
    retries = 0;
<<<<<<< HEAD
=======

>>>>>>> 673f6c3a713c3c5a521125c5e4ea6135afefe034
    if (typeof reconnect !== "undefined") {
      maxRetries = reconnect;
    }
  });
  client.onClose(function () {
    if (retries === 0) {
      handlers.close();
<<<<<<< HEAD
    }

    // Try to reconnect.
    client = null;

    // After 10 retries stop trying, to prevent logspam.
=======
    } // Try to reconnect.


    client = null; // After 10 retries stop trying, to prevent logspam.

>>>>>>> 673f6c3a713c3c5a521125c5e4ea6135afefe034
    if (retries < maxRetries) {
      // Exponentially increase timeout to reconnect.
      // Respectfully copied from the package `got`.
      // eslint-disable-next-line no-restricted-properties
      var retryInMs = 1000 * Math.pow(2, retries) + Math.random() * 100;
      retries += 1;
      log.info("Trying to reconnect...");
      setTimeout(function () {
        socket(url, handlers, reconnect);
      }, retryInMs);
    }
  });
  client.onMessage(
  /**
   * @param {any} data
   */
  function (data) {
    var message = JSON.parse(data);
<<<<<<< HEAD
=======

>>>>>>> 673f6c3a713c3c5a521125c5e4ea6135afefe034
    if (handlers[message.type]) {
      handlers[message.type](message.data, message.params);
    }
  });
};
<<<<<<< HEAD
=======

>>>>>>> 673f6c3a713c3c5a521125c5e4ea6135afefe034
export default socket;